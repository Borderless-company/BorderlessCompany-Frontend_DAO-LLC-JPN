import { FC, forwardRef, ForwardedRef } from "react";
import { AoIFormData } from "@/types/aoi";
import { useTranslation } from "next-i18next";
import { cn } from "@heroui/react";

type AoIPreviewProps = {
  formData: AoIFormData;
  onlyPreview?: boolean;
  className?: string;
};

export const AoIPreview = forwardRef<HTMLDivElement, AoIPreviewProps>(
  ({ formData, onlyPreview, className }, ref) => {
    const { t } = useTranslation("aoi");

    // 支店があるかどうかをチェック
    const hasBranch = formData.branchLocations.some((loc) => !!loc);

    // 条番号を取得する関数
    const getArticleNumber = (baseNumber: number) => {
      // 支店がない場合、第4条以降は1つ前にずらす
      if (!hasBranch && baseNumber >= 4) {
        return baseNumber;
      }
      return baseNumber + 1;
    };

    return (
      <div
        className={cn(
          "flex flex-col gap-4 flex-1 h-full pt-4 border-l-divider overflow-scroll",
          !onlyPreview && "border-l-1 p-4",
          className
        )}
      >
        {!onlyPreview && (
          <p className="font-label-lg text-neutral">{t("Preview of AoI")}</p>
        )}
        <div className="prose-preview" ref={ref}>
          <h1>定款</h1>
          <h2>第１章 総則</h2>

          <h3>第1条 (商号)</h3>
          <p>
            当会社は、{formData.companyNameJp || "＿＿＿"}と称し、英文では
            {formData.companyNameEn || "＿＿＿"}と表示する。
          </p>

          <h3>第2条 (目的)</h3>
          <p>
            当会社は、次の事業を営むことを目的とする。
            <ul>
              {formData.businessPurpose.split("\n").map((purpose, index) => (
                <li key={index}>{purpose || "＿＿＿"}</li>
              ))}
            </ul>
          </p>

          <h3>第3条 (本店の所在地)</h3>
          <p>当会社は、本店を{formData.location || "＿＿＿"}に置く。</p>

          {hasBranch && (
            <>
              <h3>第4条 (支店の所在地)</h3>
              <p>
                当会社は、支店を
                {formData.branchLocations.filter((loc) => loc).length > 0 ? (
                  formData.branchLocations
                    .filter((loc) => loc)
                    .map((location, index) => (
                      <span key={index}>
                        {index > 0 && "、"}
                        {location}
                      </span>
                    ))
                ) : (
                  <span>＿＿＿</span>
                )}
                に置く。
              </p>
            </>
          )}

          <h3>第{getArticleNumber(4)}条 (公告の方法)</h3>
          <p>当会社の公告は、官報に掲載する方法で行う。</p>

          <h2>第2章 社員及び出資</h2>

          <h3>
            第{getArticleNumber(5)}条 (社員の氏名又は名称、住所、出資及び責任)
          </h3>
          <ol>
            <li>
              当会社の業務を執行する社員（以下「業務執行社員」という。）の氏名又は名称、住所、出資の目的及びその価額は次のとおりである。
              <ul>
                {formData.executiveMembers.map(
                  (member, index) =>
                    member.name && (
                      <li key={index}>
                        名 称 {member.name}
                        <br />
                        <span className="ml-4">住 所 {member.address}</span>
                        <br />
                        <span className="ml-4">
                          出資の目的及びその価額 金銭 金
                          {parseInt(member.investment || "0").toLocaleString()}
                          円
                        </span>
                      </li>
                    )
                )}
              </ul>
            </li>
            <li>
              当会社の業務執行社員以外の社員（以下「非業務執行社員」という。）の氏名又は名称、住所、出資の目的及びその価額は別紙社員名簿のとおりである。なお、社員名簿は本定款の一部を構成するものとする。
            </li>
            <li>当会社の社員は、全て有限責任社員とする。</li>
            <li>
              非業務執行社員は、第2項に定める社員名簿について、閲覧、謄写その他開示を求めることはできないものとする。
            </li>
            <li>
              業務執行社員は、法令に基づく場合、人の生命、身体又は財産の保護のために必要がある場合、国の機関若しくは地方公共団体又はその委託を受けた者が法令の定める事務を遂行することに対して協力する必要がある場合等の合理的な必要性がある場合を除き、同社員名簿について、閲覧、謄写その他開示ができないよう技術的な措置を講じるものとする。
            </li>
          </ol>

          <h3>第{getArticleNumber(6)}条 (トークンについて)</h3>
          <ol>
            <li>
              当会社の社員となることができる者は、当会社が発行し、当会社の社員権を表章するトークン（以下「社員権トークン」という。）を保有する者（以下「社員権トークンホルダー」という。）に限る。なお、「社員権トークン」とは、当法人が発行する非代替性トークンであって、電子情報処理組織を用いて移転することができ、かつ、DAO総会において別途定めるトークン規程に従い発行されるものをいう。
            </li>
            <li>
              当会社は、ガバナンストークンを発行することができ、ガバナンストークンを保有する者をガバナンストークンホルダー（以下、社員権トークンホルダーと合わせて、「トークンホルダー」という。）として扱うものとする。なお、「ガバナンストークン」とは、社員権トークンとは別の、当法人が発行する非代替性トークンであって、電子情報処理組織を用いて移転することができ、別途定めるトークン規程に従い発行されるものをいう。
            </li>
            <li>
              ウォレットを紛失した場合の社員権トークン及びガバナンストークンの再発行は、DAO総会において別途定めるトークン規程に従うものとする。
            </li>
          </ol>

          <h3>第{getArticleNumber(7)}条 (社員の加入)</h3>
          <ol>
            <li>
              社員権トークンを保有する者を、新たに社員として当会社に加入させようとするときは、DAO総会において別途定めるトークン規程に従い、定款又は社員名簿に必要事項を記入させるものとする。
            </li>
            <li>
              社員権トークンの保有者は、定款又は社員名簿に自らが社員であると記入することを請求することができる。
            </li>
            <li>
              前二項に従って当該記入が完了した時点で、当会社の社員として当会社に加入したものとし、前項に従って請求した者が保有する社員権トークンにつき元保有者が存在する場合には、当該元保有者は、当会社の社員たる資格を失う。なお、当該加入に伴う定款変更について、総社員の同意は要しないものとし、DAO総会において別途定めるトークン規程に従い、本定款、当会社の指定する規程類及び当会社の要求する手続が完了されたことをもって、定款変更がなされたものとする。但し、当会社が新たに社員を加入させる場合において、新たに社員となろうとする者が第1項に従って当該記入が完了した時にその出資に係る払込み又は給付の全部又は一部を履行していないときは、その者は、当該払込み又は給付を完了した時に、当会社の社員となる。
            </li>
            <li>
              社員が死亡した場合、当該社員の相続人は当該社員の持分を承継する。
            </li>
            <li>
              前項に規定する場合、相続人が2人以上あるときは、死亡した社員から承継した社員権トークンを保有する相続人（以下「相続人代表者」という。）のみが、各相続人が承継した持分について権利を行使することができる。
            </li>
            <li>
              前項に規定する場合、当会社が相続人代表者に対して行った行為は、特に留保なき限り、相続人全員に対するものとみなし、相続人代表者が社員として当会社に対してなした行為は、特に留保なき限り、当該相続人全員のものとみなす。
            </li>
          </ol>

          <h3>第{getArticleNumber(8)}条 (持分の譲渡制限)</h3>
          <p>
            当会社の社員は、他の社員の全員の承諾がなければ、その持分の全部又は一部を他人に譲渡、担保設定又はその他の処分をすることができない。ただし、社員権トークンにかかる権利とともに譲渡その他の処分をする場合は、他の社員の承諾及びその他の同意等は要しないものとする。
          </p>

          <h3>第{getArticleNumber(9)}条 (社員の退社)</h3>
          <ol>
            <li>
              各社員は、次に掲げる事由に該当した場合、退社するものとする。
              <ol type="a">
                <li>DAO総会の決議がなされたとき</li>
                <li>会社法第859条の定めに基づく除名</li>
              </ol>
            </li>
            <li>
              各社員は、前項に掲げる場合、並びに会社法第609条第1項、第642条第2項及び第845条の場合のほか、次に掲げる事由による場合を除き、退社することができない。
              <ol type="a">
                <li>やむを得ない事由があるとき</li>
                <li>総社員の同意があるとき</li>
              </ol>
            </li>
            <li>
              当会社の社員は、破産手続その他の法的倒産手続開始の決定があった場合、解散した場合、又は後見開始の審判を受けた場合であっても、自ら退社することはできない。
            </li>
            <li>
              当会社の社員は、合併により消滅した場合であっても、当該合併に係る存続会社が当該消滅した社員の持分を承継するものとし、当該存続会社は、自ら退社することはできないものとする。
            </li>
            <li>
              当会社は、退社した社員の社員権トークンを失効、又は当会社が指定する第三者に譲渡させることができる。
            </li>
            <li>
              退社した社員は、その出資の種類を問わず、その持分の払戻しを受けることができない。
            </li>
            <li>
              第1項及び前項の規定は、第1項第1号又は同項第2号により当会社を退社した非業務執行社員に対する損害賠償請求を妨げない。
            </li>
          </ol>

          <h2>第3章 業務の執行及び会社の代表</h2>

          <h3>第{getArticleNumber(10)}条 (業務執行社員)</h3>
          <ol>
            <li>
              業務執行社員は、次に掲げる正当な事由がある場合に限り、DAO総会の決議によって解任することができる。
              <ol type="a">
                <li>出資の義務を履行しないこと</li>
                <li>業務を執行するにあたって不正行為があったこと</li>
                <li>重要な義務を尽くさないこと</li>
                <li>著しい不適任</li>
                <li>心身の故障</li>
              </ol>
            </li>
            <li>
              会社法第593条第3項及び同条第4項の規定は業務執行社員に対して適用されない。
            </li>
          </ol>

          <h3>第{getArticleNumber(11)}条 (代表社員)</h3>
          <ol>
            <li>
              当会社を代表する社員（以下「代表社員」という。）は、DAO総会の決議によって推薦された業務執行社員を、業務執行社員の互選により選定する。
              当該規定は、DAO総会の決議により変更することができるものとする。
            </li>
            <li>
              設立時の代表社員は、
              {formData.executiveMembers.find((m) => m.isRepresentative)
                ?.name || "＿＿＿"}
              とする。
            </li>
          </ol>

          <h3>第{getArticleNumber(12)}条 (業務執行の決定)</h3>
          <ol>
            <li>
              当会社の業務執行（トレジャリーその他資金の運用を含む。）は、DAO総会において別途定める運営規程に従うものとする。なお、DAO総会の決定を要する重要な事項は第
              {getArticleNumber(16)}
              条に従って決定し、当該事項の業務の執行は、上記の決定に基づき行わなければならない。
            </li>
            <li>
              業務執行社員は、法令又は本定款に別段の定めがある場合を除き、DAO総会の決議に従い、当会社の業務の決定及び業務の執行にかかる権限を第三者に授権することができるものとする。
            </li>
            <li>
              業務執行社員は、善良な管理者の注意をもって、その職務を行う。
            </li>
            <li>
              業務執行社員が、DAO総会の決議及びDAO総会において別途定める運営規程に従い、業務を決定し、当該業務を執行したことにより当会社に対して損害を生じさせた場合、当該業務執行社員の故意若しくは重過失に基づくもの又は法令に違反しているものでない限り、当該業務執行社員は、当該損害を賠償する責任を免除される。
            </li>
            <li>
              業務執行社員が、前項の場合を除き、その任務を怠ったことにより当会社に対して損害を生じさせた場合であっても、当該業務執行社員の故意又は重過失に基づくものでない限り、当該業務執行社員は、当該損害を賠償する責任を免除される。
            </li>
            <li>
              DAO総会において別途定める運営規程で規定されていない事項については、業務執行社員の過半数の同意で決定するものとする。
            </li>
          </ol>

          <h3>第{getArticleNumber(13)}条 (競業及び利益相反取引の許容)</h3>
          <ol>
            <li>
              社員は、(ⅰ)自己又は第三者のために当会社と同種の事業の部類に属する取引をすること、又は（ii)当会社の事業と同種の事業を目的とする他の会社、組合（民法上の組合、投資事業有限責任組合、匿名組合、ジェネラル・パートナーシップ、リミテッド・パートナーシップその他これらに類するものを含む。以下本条において同じ。）若しくはその他の団体の社員（無限責任社員を含む。）、組合員（無限責任組合員及びジェネラル・パートナーを含む。）、株主、出資者、取締役若しくは業務執行者となることができる。
            </li>
            <li>
              前項の規定にかかわらず、業務執行社員は、次に掲げる行為を行うことができない。ただし、DAO総会の決議によって承認された場合はこの限りではない。
              <ol type="a">
                <li>
                  自己又は第三者のために当会社と同種の事業の部類に属する取引をすること
                </li>
                <li>
                  当会社の事業と同種の事業を目的とする他の会社、組合若しくはその他の団体の社員（無限責任社員を含む。）、組合員（無限責任組合員及びジェネラル・パートナーを含む。）、株主、出資者、取締役若しくは業務執行者となること
                </li>
              </ol>
            </li>
            <li>
              社員は、自己又は第三者のために当会社と取引をすることができる。当会社は、社員の債務を保証することその他第三者との間で当会社と社員の利益が相反する取引を行うことができる。
            </li>
            <li>
              前項の規定にかかわらず、業務執行社員は、以下に掲げる取引を行うことができない。ただし、DAO総会の決議によって承認された場合はこの限りではない。
              <ol type="a">
                <li>
                  業務執行社員が自己又は第三者のために当会社と取引を行うこと
                </li>
                <li>
                  当会社が業務執行社員の債務を保証することその他第三者との間で当会社と業務執行社員の利益が相反する取引を行うこと
                </li>
              </ol>
            </li>
          </ol>

          <h2>第4章 DAO総会</h2>

          <h3>第{getArticleNumber(14)}条 (DAO総会の設置)</h3>
          <ol>
            <li>当会社は、トークンホルダー全員で組織するDAO総会を置く。</li>
            <li>
              DAO総会において別途定めるDAO総会規程で規定されていない事項については、トークンホルダーの過半数の同意で決定するものとする。
            </li>
          </ol>

          <h3>第{getArticleNumber(15)}条 (DAO総会の権限)</h3>
          <p>
            DAO総会は、以下の権限を有するものとし、DAO総会において別途定めるDAO総会規程に従い、決議を行うものとする。
          </p>
          <ol>
            <li>
              当会社のガバナンス、ファイナンス及び業務執行に関する重要な事項の決定
            </li>
            <li>利益の配当及び残余財産の分配</li>
            <li>利益相反取引についての承認</li>
            <li>
              総社員の同意を要する事項に係る同意内容案の事前協議及びその決定
            </li>
            <li>支配人の選任及び解任</li>
            <li>社員の退社</li>
            <li>
              定款変更の決定（ただし、本定款で別段の定めをする場合を除く。）
            </li>
            <li>清算人の解任</li>
            <li>会社法第650条第2項及び第3項に定める業務の執行に関する事項</li>
            <li>組織変更の決定</li>
            <li>
              会社法第793条、第802条又は第813条に従った当会社の吸収合併等についての吸収合併契約書等の締結及び当会社の事業の全部又は重要な一部の譲渡の決定
            </li>
          </ol>

          <h3>第{getArticleNumber(16)}条 (DAO総会の決議事項)</h3>
          <p>
            前条第1号によりDAO総会の決定を要する重要な事項は、DAO総会において別途定めるDAO総会規程の定めによるものとする。
          </p>

          <h3>第{getArticleNumber(17)}条 (DAO総会の招集及び決議方法)</h3>
          <ol>
            <li>
              DAO総会の招集は、DAO総会において別途定めるDAO総会規程に従い、行われるものとする。
            </li>
            <li>
              DAO総会の決議に際しては、各トークンホルダーはDAO総会において別途定めるトークン規程の規定に従った議決権を有するものとし、決議方法の詳細については、DAO総会において別途定める
              DAO総会規程において定めることとする。
            </li>
          </ol>

          <h2>第5章 社員総会</h2>

          <h3>第{getArticleNumber(18)}条 (社員総会の設置)</h3>
          <p>当会社は、社員全員で組織する社員総会を置く。</p>

          <h3>第{getArticleNumber(19)}条 (社員総会の権限)</h3>
          <p>
            会社法その他の法令により、社員による同意又は決定等が定められている事項（但し、第
            {getArticleNumber(15)}
            条によりDAO総会の権限とされている事項は除く。）については、DAO総会において別途定める社員総会規程に従い、社員総会による決議を行うものとする。
          </p>

          <h3>第{getArticleNumber(20)}条 (請求等の通知)</h3>
          <p>
            社員が第三者から、当会社の事業に関して、請求その他何らかの権利の主張を受けた場合、当該社員は直ちにその旨を業務執行社員に通知するものとする。業務執行社員は、かかる通知受領後速やかに、当該社員が、かかる請求ないし権利の主張を直接に受けることがないようにするために必要な措置を採るものとし、当該社員は業務執行社員の措置に協力するものとする。
          </p>

          <h2>第6章 計算</h2>

          <h3>第{getArticleNumber(21)}条 (事業年度)</h3>
          <p>
            当会社の事業年度は、毎年
            {formData.businessStartDate
              ? formData.businessStartDate
                  .toDate("JST")
                  .toLocaleDateString("ja-JP", {
                    month: "long",
                    day: "numeric",
                  })
              : "＿＿＿"}
            から翌年
            {formData.businessEndDate
              ? formData.businessEndDate
                  .toDate("JST")
                  .toLocaleDateString("ja-JP", {
                    month: "long",
                    day: "numeric",
                  })
              : "＿＿＿"}
            までとする。
          </p>

          <h3>第{getArticleNumber(22)}条 (計算書類等の承認)</h3>
          <p>
            当会社の各事業年度に係る計算書類は、各事業年度末日の翌日から起算して3ヶ月以内に、DAO総会の決議により承認されなければならない。
          </p>

          <h3>第{getArticleNumber(23)}条 (利益の配当及び残余財産の分配)</h3>
          <ol>
            <li>
              当会社が利益の配当をしようとするときは、配当直前時点の社員権トークンホルダーに配当するものとし、DAO総会の決議によって、次に掲げる事項を定めなければならない。
              <ol type="a">
                <li>配当財産の種類及び帳簿価額の総額</li>
                <li>
                  社員権トークンホルダーに対する配当財産の割当てに関する事項
                </li>
                <li>当該利益の配当がその効力を生じる日</li>
              </ol>
            </li>
            <li>
              社員権トークンホルダーは、前項の決定後でなければ、当会社に対して利益配当の請求をすることができない。
            </li>
            <li>
              当会社の債務等を弁済し又は弁済に必要な資金を留保した後の分配可能な残余財産の全部について、DAO総会において別途定めるトークン規程の規定に従って分配する。DAO総会において別途定めるトークン規程に定めがない場合、各社員の出資の価額に応じて按分するものとする。
            </li>
            <li>
              業務執行社員以外のトークンホルダーは、その出資の価額を超えて利益の配当、残余財産の分配又はトークンホルダーとしての立場において受ける財産の提供（社員権トークン及びガバナンストークン以外のトークンの割当てが利益の配当、残余財産の分配又はトークンホルダーとしての立場において受ける財産の提供と実質的に同視できる場合を含む。）を受けることができない。
            </li>
          </ol>

          <h3>第{getArticleNumber(24)}条 (損益分配の割合)</h3>
          <p>
            各社員の損益分配の割合は、DAO総会において別途定めるトークン規程の規定に従う。DAO総会において別途定めるトークン規程に定めがない場合、各社員の出資の価額に応じて按分するものとする。
          </p>

          <h2>第7章 解散</h2>

          <h3>第{getArticleNumber(25)}条 (解散)</h3>
          <p>当会社は、次に掲げる事由によって、解散する。</p>
          <ol>
            <li>総社員の同意</li>
            <li>DAO総会の決議がなされたとき</li>
            <li>社員が欠けたこと</li>
            <li>合併（合併により当会社が消滅する場合に限る。）</li>
            <li>破産手続開始の決定</li>
            <li>
              会社法第824条第1項又は第833条第2項の規定による解散を命ずる裁判
            </li>
          </ol>

          <h2>第8章 附則</h2>

          <h3>第{getArticleNumber(26)}条 (最初の事業年度)</h3>
          <p>
            当会社の最初の事業年度は、当会社成立の日から
            {formData.establishmentDate
              ? formData.establishmentDate
                  .toDate("JST")
                  .toLocaleDateString("ja-JP", {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                  })
              : "＿＿＿"}
            までとする。
          </p>

          <h3>第{getArticleNumber(27)}条 (設立に際する出資)</h3>
          <p>
            当会社の資本金は金
            {parseInt(formData.capital || "0").toLocaleString()}
            円とする。
          </p>

          <h3>第{getArticleNumber(28)}条 (本店の所在場所)</h3>
          <p>
            当会社の設立時の本店の所在場所は、{formData.location || "＿＿＿"}
            とする。
          </p>

          <h3>第{getArticleNumber(29)}条 (その他)</h3>
          <p>
            本定款に規定のない事項は、すべて会社法その他の法令に従うものとする。
          </p>

          <p className="mt-8">
            {formData.establishmentDate
              ? formData.establishmentDate
                  .toDate("JST")
                  .toLocaleDateString("ja-JP", {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                  })
              : "＿＿＿年＿＿月＿＿日"}
          </p>

          <div className="mt-4">
            {formData.executiveMembers.map((member, index) => (
              <p key={index}>有限責任社員 {member.name}</p>
            ))}
          </div>
        </div>
      </div>
    );
  }
);

// DisplayName設定
AoIPreview.displayName = "AoIPreview";
